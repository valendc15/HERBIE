# Integraci√≥n del Enhanced Framework Manager en el HerbieAgent original
from typing import Optional

from frameworkManager import *
from herbie import *


# Modificaciones en HerbieFrameworkHelper
class EnhancedHerbieFrameworkHelper:
    def __init__(self, llm):
        self.llm = llm
        self.cli_manager = IntelligentCLIManager(llm)
        self.system_info = {
            "os": platform.system().lower(),
            "version": platform.release(),
            "architecture": platform.machine()
        }

    def check_framework_requirements(self, framework: str) -> Dict:
        """Verifica requisitos usando el sistema mejorado"""
        setup_result = self.cli_manager.generate_setup_instructions(framework, "temp_project")

        if setup_result.success:
            return {
                "available": True,
                "dependencies": setup_result.dependencies,
                "setup_commands": setup_result.setup_commands
            }
        else:
            return {
                "available": False,
                "reason": setup_result.message,
                "dependencies": setup_result.dependencies,
                "setup_commands": setup_result.setup_commands,
                "troubleshooting": setup_result.troubleshooting
            }

    def generate_intelligent_setup_guide(self, framework: str, project_name: str) -> str:
        """Genera gu√≠a inteligente de configuraci√≥n"""
        setup_result = self.cli_manager.generate_setup_instructions(framework, project_name)

        if not self.llm:
            return self._generate_basic_guide(setup_result)

        try:
            from langchain.schema import HumanMessage

            # Preparar informaci√≥n de dependencias
            dep_info = []
            for dep in setup_result.dependencies:
                status_emoji = {
                    DependencyStatus.AVAILABLE: "‚úÖ",
                    DependencyStatus.MISSING: "‚ùå",
                    DependencyStatus.OUTDATED: "‚ö†Ô∏è",
                    DependencyStatus.UNKNOWN: "‚ùì"
                }

                dep_info.append({
                    "name": dep.name,
                    "status": dep.status.value,
                    "emoji": status_emoji[dep.status],
                    "current_version": dep.current_version,
                    "required_version": dep.required_version,
                    "install_command": dep.install_command
                })

            prompt = f"""
Eres Herbie, un agente t√©cnico experto y amigable.

Situaci√≥n del proyecto:
- Framework: {framework}
- Proyecto: {project_name}
- Sistema: {self.system_info['os']}
- Configuraci√≥n exitosa: {setup_result.success}

Dependencias analizadas:
{json.dumps(dep_info, indent=2)}

Comandos de configuraci√≥n:
{json.dumps(setup_result.setup_commands, indent=2)}

Pr√≥ximos pasos:
{json.dumps(setup_result.next_steps, indent=2)}

Genera una gu√≠a completa que incluya:
1. üìã Resumen del estado actual
2. üîß Dependencias necesarias (con estado actual)
3. üìù Instrucciones paso a paso espec√≠ficas para {self.system_info['os']}
4. üöÄ Comandos exactos para ejecutar
5. üîç C√≥mo verificar que todo funciona
6. üÜò Soluci√≥n de problemas comunes
7. üéØ Pr√≥ximos pasos despu√©s de la configuraci√≥n

Usa formato Markdown, emojis apropiados y s√© muy espec√≠fico con los comandos.
El tono debe ser profesional pero amigable, como un mentor t√©cnico.
"""

            response = self.llm.invoke([HumanMessage(content=prompt)])
            return response.content.strip()

        except Exception as e:
            logger.error(f"Error generando gu√≠a con IA: {e}")
            return self._generate_basic_guide(setup_result)

    def _generate_basic_guide(self, setup_result: FrameworkSetupResult) -> str:
        """Genera gu√≠a b√°sica sin IA"""
        guide = f"""
# Gu√≠a de Configuraci√≥n

## Estado: {"‚úÖ Listo" if setup_result.success else "‚ùå Necesita configuraci√≥n"}

### Dependencias:
"""

        for dep in setup_result.dependencies:
            status_emoji = {
                DependencyStatus.AVAILABLE: "‚úÖ",
                DependencyStatus.MISSING: "‚ùå",
                DependencyStatus.OUTDATED: "‚ö†Ô∏è",
                DependencyStatus.UNKNOWN: "‚ùì"
            }

            guide += f"\n- {status_emoji[dep.status]} **{dep.name}**: {dep.status.value}"
            if dep.current_version:
                guide += f" (versi√≥n: {dep.current_version})"
            if dep.install_command:
                guide += f"\n  - Instalaci√≥n: `{dep.install_command}`"

        guide += "\n\n### Comandos de configuraci√≥n:\n"
        for cmd in setup_result.setup_commands:
            guide += f"```bash\n{cmd}\n```\n"

        guide += "\n### Pr√≥ximos pasos:\n"
        for step in setup_result.next_steps:
            guide += f"- {step}\n"

        if setup_result.troubleshooting:
            guide += f"\n### Soluci√≥n de problemas:\n{setup_result.troubleshooting}"

        return guide

    def init_framework_project(self, project_info: ProjectInfo) -> Dict:
        """Inicializa proyecto usando el sistema mejorado"""
        logger.info(f"Iniciando proyecto {project_info.repo_name} con framework {project_info.framework}")

        # Usar el CLI manager mejorado
        setup_result = self.cli_manager.execute_framework_setup(
            project_info.framework,
            project_info.repo_name,
            auto_install=True
        )

        if setup_result.success:
            return {
                "success": True,
                "message": setup_result.message,
                "setup_result": setup_result
            }
        else:
            return {
                "success": False,
                "message": setup_result.message,
                "setup_guide": self.generate_intelligent_setup_guide(
                    project_info.framework,
                    project_info.repo_name
                ),
                "setup_result": setup_result
            }


# Modificaciones en el AIIntelligenceCore
class EnhancedAIIntelligenceCore(AIIntelligenceCore):
    """Versi√≥n mejorada del n√∫cleo de IA con soporte para CLI inteligente"""

    def __init__(self, llm):
        super().__init__(llm)
        self.cli_manager = IntelligentCLIManager(llm)

    def generate_framework_status_response(self, framework: str, project_name: str,
                                           user_input: str) -> str:
        """Genera respuesta sobre el estado del framework"""

        setup_result = self.cli_manager.generate_setup_instructions(framework, project_name)

        prompt = f"""
Eres Herbie, un agente t√©cnico amigable.

El usuario pregunt√≥: "{user_input}"

Informaci√≥n del framework {framework}:
- Configuraci√≥n exitosa: {setup_result.success}
- Mensaje del sistema: {setup_result.message}
- Dependencias: {len(setup_result.dependencies)} analizadas

Estado de dependencias:
"""

        for dep in setup_result.dependencies:
            prompt += f"- {dep.name}: {dep.status.value}"
            if dep.current_version:
                prompt += f" (v{dep.current_version})"
            if dep.required_version:
                prompt += f" [requiere: {dep.required_version}]"
            prompt += "\n"

        prompt += f"""
Comandos necesarios: {len(setup_result.setup_commands)}
Pr√≥ximos pasos: {len(setup_result.next_steps)}

Genera una respuesta que:
1. Responda espec√≠ficamente a la pregunta del usuario
2. Proporcione el estado actual del framework
3. Indique claramente qu√© necesita hacer el usuario
4. Sea t√©cnicamente preciso pero f√°cil de entender
5. Use emojis apropiados y formato markdown
6. Incluya comandos espec√≠ficos si es necesario

Si hay dependencias faltantes, enf√≥cate en eso.
Si todo est√° listo, enf√≥cate en crear el proyecto.
"""

        try:
            response = self.llm.invoke([HumanMessage(content=prompt)])
            return response.content.strip()
        except Exception as e:
            logger.error(f"Error generando respuesta de framework: {e}")
            return f"Hay un problema t√©cnico analizando {framework}. {setup_result.message}"

    def analyze_framework_readiness(self, framework: str, project_name: str) -> Dict:
        """Analiza si el framework est√° listo para usar"""

        setup_result = self.cli_manager.generate_setup_instructions(framework, project_name)

        missing_deps = [dep for dep in setup_result.dependencies
                        if dep.status == DependencyStatus.MISSING]
        outdated_deps = [dep for dep in setup_result.dependencies
                         if dep.status == DependencyStatus.OUTDATED]

        readiness_score = 1.0
        if missing_deps:
            readiness_score -= 0.5
        if outdated_deps:
            readiness_score -= 0.3

        return {
            "ready": setup_result.success,
            "readiness_score": readiness_score,
            "missing_dependencies": [dep.name for dep in missing_deps],
            "outdated_dependencies": [dep.name for dep in outdated_deps],
            "setup_commands": setup_result.setup_commands,
            "next_steps": setup_result.next_steps,
            "full_result": setup_result
        }


# Modificaciones en GitHubRepoCreator
class EnhancedGitHubRepoCreator(GitHubRepoCreator):
    """Versi√≥n mejorada del creador de repositorios"""

    def __init__(self):
        super().__init__()
        # Reemplazar el framework helper con la versi√≥n mejorada
        self.framework_helper = EnhancedHerbieFrameworkHelper(self.llm)
        # Reemplazar el AI core con la versi√≥n mejorada
        self.ai_core = EnhancedAIIntelligenceCore(self.llm)


# Modificaciones en HerbieAgent
class EnhancedHerbieAgent(HerbieAgent):
    """Versi√≥n mejorada del agente con CLI inteligente"""

    def __init__(self):
        # Usar la versi√≥n mejorada del repo creator
        self.repo_creator = EnhancedGitHubRepoCreator()
        self.ai_core = self.repo_creator.ai_core
        self.conversation_history = []
        self.pending_project = None
        self.user_context = {}

    def _handle_framework_inquiry(self, user_input: str, framework: str = None) -> str:
        """Maneja preguntas espec√≠ficas sobre frameworks"""

        if not framework:
            # Intentar extraer framework del input
            framework = self._extract_framework_from_input(user_input)

        if not framework:
            return self.ai_core.generate_response(
                intent="framework_inquiry_no_framework",
                context={"available_frameworks": EnhancedFrameworkDatabase.get_framework_names()},
                user_input=user_input
            )

        # Generar respuesta espec√≠fica sobre el framework
        response = self.ai_core.generate_framework_status_response(
            framework,
            "proyecto-ejemplo",
            user_input
        )

        self.conversation_history.append({"role": "assistant", "content": response})
        return response

    def _extract_framework_from_input(self, user_input: str) -> Optional[str]:
        """Extrae framework mencionado en el input"""
        frameworks = EnhancedFrameworkDatabase.get_framework_names()
        user_lower = user_input.lower()

        for framework in frameworks:
            if framework in user_lower:
                return framework

        # Buscar variaciones comunes
        variations = {
            "react": ["react", "reactjs", "react.js"],
            "vue": ["vue", "vuejs", "vue.js"],
            "angular": ["angular", "angularjs"],
            "nextjs": ["next", "nextjs", "next.js"],
            "django": ["django", "python web"],
            "fastapi": ["fastapi", "fast api"],
            "rails": ["rails", "ruby on rails", "ror"],
            "flutter": ["flutter", "dart"]
        }

        for framework, terms in variations.items():
            if any(term in user_lower for term in terms):
                return framework

        return None

    def _execute_project_creation(self) -> str:
        """Versi√≥n mejorada de la ejecuci√≥n del proyecto"""
        if not self.pending_project:
            return "‚ùå No hay proyecto pendiente para crear."

        try:
            # Analizar preparaci√≥n del framework
            framework_readiness = self.ai_core.analyze_framework_readiness(
                self.pending_project['framework'],
                self.pending_project['repo_name']
            )

            # Si el framework no est√° listo, proporcionar gu√≠a
            if not framework_readiness['ready']:
                missing_deps = framework_readiness['missing_dependencies']
                setup_guide = self.repo_creator.framework_helper.generate_intelligent_setup_guide(
                    self.pending_project['framework'],
                    self.pending_project['repo_name']
                )

                response = self.ai_core.generate_response(
                    intent="framework_not_ready",
                    context={
                        "framework": self.pending_project['framework'],
                        "project_name": self.pending_project['repo_name'],
                        "missing_dependencies": missing_deps,
                        "setup_guide": setup_guide,
                        "readiness_score": framework_readiness['readiness_score']
                    },
                    user_input="framework no est√° listo"
                )

                self.conversation_history.append({"role": "assistant", "content": response})
                return response

            # Continuar con la creaci√≥n normal del proyecto
            return super()._execute_project_creation()

        except Exception as e:
            logger.error(f"Error en ejecuci√≥n mejorada: {e}")
            return super()._execute_project_creation()


# Funci√≥n main actualizada
def enhanced_main():
    """Funci√≥n principal mejorada"""

    try:
        agent = EnhancedHerbieAgent()

        welcome_message = agent.ai_core.generate_response(
            intent="welcome_message",
            context={
                "frameworks": EnhancedFrameworkDatabase.get_framework_names(),
                "features": [
                    "Detecci√≥n inteligente de dependencias",
                    "Configuraci√≥n autom√°tica de frameworks",
                    "Gu√≠as de instalaci√≥n personalizadas",
                    "Soluci√≥n de problemas autom√°tica"
                ]
            },
            user_input="bienvenida"
        )

        print("ü§ñ Herbie - Agente Inteligente con CLI Mejorado")
        print("=" * 55)
        print(f"\n{welcome_message}")
        print("\nüí° Nuevas caracter√≠sticas:")
        print("   ‚Ä¢ Detecci√≥n autom√°tica de dependencias")
        print("   ‚Ä¢ Configuraci√≥n inteligente de frameworks")
        print("   ‚Ä¢ Gu√≠as de instalaci√≥n personalizadas")
        print("   ‚Ä¢ Soluci√≥n de problemas autom√°tica")
        print("\nüìù Ejemplos de uso:")
        print('   ‚Ä¢ "Quiero crear una app React"')
        print('   ‚Ä¢ "¬øTengo todo para hacer un proyecto Django?"')
        print('   ‚Ä¢ "Configura Angular en mi sistema"')

        while True:
            user_input = input("\nüí¨ T√∫: ").strip()

            if user_input:
                exit_analysis = agent.ai_core.analyze_user_intent(user_input, [])
                if exit_analysis.action == "despedida" and exit_analysis.confidence > 0.7:
                    farewell_message = agent.ai_core.generate_response(
                        intent="farewell",
                        context={},
                        user_input=user_input
                    )
                    print(f"\nü§ñ Herbie: {farewell_message}")
                    break

            if not user_input:
                continue

            # Detectar si es una pregunta sobre framework espec√≠fico
            framework = agent._extract_framework_from_input(user_input)
            if framework and any(
                    word in user_input.lower() for word in ["tengo", "instalado", "necesito", "configurar", "setup"]):
                print(f"\nüîç Analizando configuraci√≥n de {framework}...")
                response = agent._handle_framework_inquiry(user_input, framework)
            else:
                print()
                response = agent.chat(user_input)

            print(f"ü§ñ Herbie: {response}")

    except KeyboardInterrupt:
        print("\n\nüëã ¬°Hasta luego! ¬°Que tengas un desarrollo incre√≠ble! üöÄ")
    except Exception as e:
        print(f"\n‚ùå Error inicializando Herbie: {e}")
        print("\nüîß Aseg√∫rate de tener configurado:")
        print("   ‚Ä¢ GITHUB_TOKEN: Token de GitHub con permisos de repositorio")
        print("   ‚Ä¢ GOOGLE_API_KEY: API key de Google Generative AI")


if __name__ == "__main__":
    enhanced_main()